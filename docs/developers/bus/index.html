<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Theatersoft - Docs</title>
    <meta name="author" content="Theatersoft">
    <meta name="description" content="Theatersoft">
    <meta name="viewport" content="width=device-width"/>
    <link rel="manifest" href="assets/manifest.json">
    <link rel="icon" type="image/png" href="/assets/theatersoft-logo-round-accent-48.png"/>
    <link rel="stylesheet" href="/theatersoft.css">
    <script defer src="/theatersoft.js"></script>
    <script>
        window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
        ga('create', 'UA-105697373-1', 'auto');
        ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Organization",
        "url": "http://www.theatersoft.com",
        "name": "Theatersoft",
        "logo": "http://www.theatersoft.com/assets/theatersoft-logo-round-accent.png"
    }
    </script>
</head>
<body>
<svg display="none"><symbol id="svg-logo" viewBox="0 0 280 240"><path d="m132.7 21.94-100.5 58.06c-4.385 2.536-7.077 7.161-7.076 12.16v3.018 109.8c-.0029 7.791 6.424 14.11 14.36 14.11h64.73c7.932-.008 14.36-6.322 14.36-14.11v-25.11c10.5-5.275 17.85-15.91 17.85-28.16 0-17.37-14.63-31.75-32.31-31.75-17.68.00001-32.31 14.38-32.31 31.75 0 12.33 7.44 23.02 18.04 28.26v10.91h-35.99v-90.67l86.17-49.78 86.16 49.78v91.36l-35.8-.5008v-11.2c10.5-5.275 17.85-15.91 17.85-28.16 0-17.37-14.63-31.75-32.31-31.75s-32.31 14.38-32.31 31.75c0 12.33 7.44 23.02 18.04 28.26v25.01c-.005 7.718 6.307 14.01 14.16 14.11l64.51.8766c8.012.1153 14.57-6.231 14.57-14.1v-113.7c.00083-4.998-2.691-9.624-7.076-12.16l-100.6-58.1c-2.077-1.195-4.427-1.858-6.834-1.929-2.709-.0862-5.388.5824-7.726 1.929z"></path></symbol><symbol id="svg-github" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></symbol><symbol id="svg-list" viewBox="0 0 32 32"><path d="M25.6 14.4h-19.2c-0.883 0-1.6 0.717-1.6 1.6s0.717 1.6 1.6 1.6h19.2c0.885 0 1.6-0.717 1.6-1.6s-0.715-1.6-1.6-1.6zM6.4 11.2h19.2c0.885 0 1.6-0.717 1.6-1.6s-0.715-1.6-1.6-1.6h-19.2c-0.883 0-1.6 0.717-1.6 1.6s0.717 1.6 1.6 1.6zM25.6 20.8h-19.2c-0.883 0-1.6 0.715-1.6 1.6s0.717 1.6 1.6 1.6h19.2c0.885 0 1.6-0.715 1.6-1.6s-0.715-1.6-1.6-1.6z"></path></symbol><symbol id="svg-x" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M7.48 8l3.75 3.75-1.48 1.48L6 9.48l-3.75 3.75-1.48-1.48L4.52 8 .77 4.25l1.48-1.48L6 6.52l3.75-3.75 1.48 1.48z"></path></symbol></svg>
<nav><a href="/"><svg><use href="#svg-logo"></use></svg><span>Theatersoft</span></a><ul id="_566"><a href="/docs/" class="_40d">Docs</a><a href="/install/" class>Install</a><a href="https://community.theatersoft.com/" onclick="trackLink(event)" class>Community</a><a target="_blank" href="https://github.com/theatersoft"><svg><use href="#svg-github"></use></svg></a></ul><div id="_c62"><svg><use href="#svg-list"></use></svg></div></nav>
<header class="_593"></header>
<main class="_485"><article><div class="markdown"><h1 id="bus">bus</h1>
<p>The Bus provides solutions for remote method calls and remote event publish/subscribe between nodes in a distributed application that work much like the ones that developers already use in normal applications. </p>
<p>It uses WebSockets and JSON encoded messages, and while knowing all the details of the implementation is not necessary just to use the API, some of the key concepts need to be explained.</p>
<blockquote>
<p>Note on naming: the distinction between the <em>Node.js</em> runtime and a <em>node</em> element of a bus network.</p>
</blockquote>
<h3 id="node-names">Node names</h3>
<p>The bus network topology is a rooted tree. Each child node has at least a parent connection and may also be a parent of nested child node connections. Node connections are indexed serially starting from 1 (0 being the parent connection), such that a full path from root uniquely names each node. Node names are the basis for message routing between nodes. </p>
<p>Example: A four node network (a root with two children, one with its own child):</p>
<pre><code>/
    /1/
    /2/
        /2/1/
</code></pre><p>In this example, messages from sender node <code>/1/</code> to destination node <code>/2/1</code> route through intermediate nodes <code>/</code> and <code>/2/</code>.</p>
<h3 id="connection-context-">Connection <code>Context</code></h3>
<p>A bus node starts the bus using a Context object:</p>
<pre><code>import {bus} from &#39;@theatersoft/bus&#39;

bus.start(context)
</code></pre><p>… where <code>context</code> declares how to create the connection to the message bus. A Node.js node may omit the context and use the environment vars <code>BUS</code> and <code>AUTH</code> instead.</p>
<p>Context examples:</p>
<p><code>{parent: {url: &#39;ws://localhost:5453&#39;}}</code> creates a parent connection to a server URL.</p>
<p><code>{children: {port: 5453}}</code> creates a new <code>WebSocketServer</code> on port 5453 which creates child connections when children connect to it. </p>
<p><code>{children: {server}}</code> creates a new <code>WebSocketServer</code> using an existing http.Server or https.Server which creates child connections when children connect to it.</p>
<h3 id="bus-objects">Bus objects</h3>
<p>The bus implements remote method calls to <em>bus objects</em>, which are normal JavaScript objects that have been registered using <code>bus.registerObject (name :string, obj :any)</code>. The name argument is the object name that becomes mapped to the registered object.  </p>
<blockquote>
<p>Names beginning with an uppercase letter must be globally and locally unique since they are also registered at a global scope.</p>
<p>Names beginning with a lowercase letter are only registered at the local node and must be locally unique within the node.</p>
</blockquote>
<p>Example: Register a bus object name <code>Ping</code> with one method <code>ping</code>:  </p>
<pre><code>bus.registerObject(&#39;Ping&#39;, {ping: () =&gt; &#39;PING!&#39;})
</code></pre><p>The <em>Manager</em> is used to resolve a bus object name:</p>
<pre><code>bus.resolveName(&#39;Ping&#39;)
</code></pre><p>…returns the full path to the object, e.g. <code>/2/1/Ping</code> if it was registered on the last node in the previous example.</p>
<blockquote>
<p>Node objects always requires the full path, e.g. <code>/2/1/ping</code> </p>
</blockquote>
<h3 id="bus-object-method-calls">Bus object method calls</h3>
<p>With the full path, we can call methods on the object: </p>
<pre><code>bus.request(&#39;/2/1/Ping.ping&#39;).then(value =&gt; console.log(value))
</code></pre><p>Since the primary goal is to make the bus API easy to use, the resolution and request mechanism can be simplified using a Proxy object:</p>
<pre><code>const Ping = bus.proxy(&#39;Ping&#39;)
</code></pre><p>Bus proxy methods are callable and return values asynchronously (of course). </p>
<pre><code>Ping.ping().then(value =&gt; console.log(value))
</code></pre><h3 id="bus-signals">Bus signals</h3>
<p>Bus signals are an event publish and subscribe mechanism.</p>
<p>The return value from <code>bus.registerObject</code> is a <code>Promise&lt;BusObject&gt;</code> which is used to pubish signals to other listeners on the bus.</p>
<pre><code>export type BusObject = {
    signal :(member :string, args :mixed[]) =&gt; void
}
</code></pre><p><code>bus.registerListener (name :string, cb :Listener)</code> is used to subscribe to signals, where the signal name combines the bus object name with the member argument from <code>signal()</code>.  E.g. <code>Device.state</code>  </p>
<h3 id="authorization">Authorization</h3>
<p>Authorization is required of child connections by creating the parent server connection using a <code>Context</code> with a <code>check :(string) =&gt; Promise&lt;boolean&gt;</code> function.</p>
<p>The authorization handshake is this message from the server immediately after connection open:
<code>{&quot;auth&quot;:&quot;&quot;}</code></p>
<p>The child must respond with: <code>{&quot;auth&quot;:&lt;AUTH_STRING&gt;}</code>, which is performed by the bus using the <code>auth</code> member from the child’s <code>Context</code>. </p>
<p>If <code>check(&lt;AUTH_STRING&gt;)</code> resolves <code>true</code> then the server responds with <code>{&quot;hello&quot;:&quot;&lt;NODE_NAME&gt;&quot;}</code> and the connection is ready for use. </p>
<h3 id="connection-failure-and-reconnection">Connection failure and reconnection</h3>
<p>Since network connections are unreliable, reconnection and recovery from connection failures must occur without any user intervention.</p>
<p>The child <code>bus</code> node emits <code>disconnect</code> on a parent connection failure and begins the reconnection process. It attempts to reopen the parent connection from the child node, using an exponential backoff timeout between retries. On the parent side of the connection, the lost node is removed from the bus <code>Manager</code>, which also removes any associated bus objects. </p>
<p>Once reopen succeeds, the child re-adds its node and objects to the Manager. Then the <code>bus</code> emits a <code>reconnect</code> event. It is the reponsibility of the application developer to listen for this event and perform any further recovery actions, such as resyncing state.</p>
<h3 id="theatersoft-services">Theatersoft services</h3>
<p>Services are global bus objects with additional conventions such as service registration and lifecycle control which are out of the scope of the bus. See <a href="/doc/server/">Server</a> for more information.</p>
<h4 id="-class-bus-"><code>class Bus</code></h4>
<pre><code>    start (context :Context)
    started ()
    get root () :boolean
    get name () :string
    get proxy () :any
    registerObject (name :string, obj :any, intf :string[], meta :any) :Promise&lt;BusObject&gt;
    unregisterObject (name :string) :Promise&lt;void&gt;
    request (name :string, ...args :mixed[])
    registerListener (name :string, cb :Listener)
    unregisterListener (name :string, cb :Listener)
    on (type :string, cb :Listener)
    off (type :string, cb :Listener)
    close ()
    introspectNode (path :string)
    resolveName (name :string)
</code></pre><h4 id="-class-manager-"><code>class Manager</code></h4>
<pre><code>    names :Map&lt;Name, Path&gt;
    nodes :Map&lt;Path, Name[]&gt;

    init (path :Path) 
    addNode (path :Path) :Promise&lt;void&gt; 
    removeNode (path :Path) :Promise&lt;void&gt; 
    addName (name :Name, _sender :Path) :Promise&lt;void&gt; 
    resolveName (name :Name) :Promise&lt;Name | void&gt; 
    removeName (name :Name, _sender? :Path) :Promise&lt;void&gt; 
    check (auth :string)
</code></pre><h3 id="debugging">Debugging</h3>
<p>In a browser bus node, the WebSocket frames can be viewed using the browser’s built-in tools: </p>
<p>Example of WebSocket frames at client start up: </p>
<table>
<thead>
<tr>
<th style="text-align:left">Data</th>
<th style="text-align:left">Length</th>
<th style="text-align:left">Time</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>{&quot;auth&quot;:&quot;&quot;}</code></td>
<td style="text-align:left">11</td>
<td style="text-align:left">14:48:02.799</td>
</tr>
<tr>
<td style="text-align:left"><code>{&quot;auth&quot;:&lt;AUTH_STRING&gt;}</code></td>
<td style="text-align:left">47</td>
<td style="text-align:left">14:48:02.800</td>
</tr>
<tr>
<td style="text-align:left"><code>{&quot;hello&quot;:&quot;/42/&quot;}</code></td>
<td style="text-align:left">16</td>
<td style="text-align:left">14:48:02.817</td>
</tr>
<tr>
<td style="text-align:left"><code>{&quot;req&quot;:{&quot;path&quot;:&quot;/&quot;,&quot;intf&quot;:&quot;Bus&quot;,&quot;member&quot;:&quot;addNode&quot;,&quot;args&quot;:[&quot;/42/&quot;],&quot;sender&quot;:&quot;/42/&quot;,&quot;id&quot;:0}}</code></td>
<td style="text-align:left">91</td>
<td style="text-align:left">14:48:02.818</td>
</tr>
<tr>
<td style="text-align:left"><code>{&quot;req&quot;:{&quot;path&quot;:&quot;/&quot;,&quot;intf&quot;:&quot;Bus&quot;,&quot;member&quot;:&quot;resolveName&quot;,&quot;args&quot;:[&quot;Config&quot;],&quot;sender&quot;:&quot;/42/&quot;,&quot;id&quot;:1}}</code></td>
<td style="text-align:left">97</td>
<td style="text-align:left">14:48:02.819</td>
</tr>
<tr>
<td style="text-align:left"><code>{&quot;res&quot;:{&quot;id&quot;:0,&quot;path&quot;:&quot;/42/&quot;}}</code></td>
<td style="text-align:left">30</td>
<td style="text-align:left">14:48:02.820</td>
</tr>
<tr>
<td style="text-align:left"><code>{&quot;res&quot;:{&quot;id&quot;:1,&quot;path&quot;:&quot;/42/&quot;,&quot;res&quot;:&quot;/&quot;}}</code></td>
<td style="text-align:left">40</td>
<td style="text-align:left">14:48:02.820</td>
</tr>
<tr>
<td style="text-align:left"><code>{&quot;req&quot;:{&quot;path&quot;:&quot;/&quot;,&quot;intf&quot;:&quot;Config&quot;,&quot;member&quot;:&quot;get&quot;,&quot;args&quot;:[],&quot;sender&quot;:&quot;/42/&quot;,&quot;id&quot;:2}}</code></td>
<td style="text-align:left">84</td>
<td style="text-align:left">14:48:02.821</td>
</tr>
<tr>
<td style="text-align:left"><code>{&quot;res&quot;:{&quot;id&quot;:2,&quot;path&quot;:&quot;/42/&quot;,&quot;res&quot;:&lt;CONFIG_OBJECT&gt;}}</code></td>
<td style="text-align:left">4022</td>
<td style="text-align:left">14:48:02.823</td>
</tr>
</tbody>
</table>
<p>In both Node and browser nodes, you may rebuild the bus module using <code>npm run build:debug</code> to enable debug BUS logging.</p>
<p>Example of the same client start up from the server logs:</p>
<pre><code>Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS / adding child /42
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS   0-&gt; /Bus.addNode( /42/ ) from /42/
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS manager.addNode /42/
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS &lt;-0   undefined
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS   1-&gt; /Bus.resolveName( Config ) from /42/
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS manager.resolveName Config /
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS &lt;-1   /
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS   2-&gt; /Config.get( ) from /42/
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT bus Config.get
Mar 01 14:48:02 office theatersoft[10506]: THEATERSOFT BUS &lt;-2   &lt;CONFIG_OBJECT&gt;
</code></pre></div></article></main>
<footer><div><span>© 2018 Theatersoft, LLC</span></div></footer>
</body>
</html>