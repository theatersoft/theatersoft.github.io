<!DOCTYPE html>
<html>
<head>
    <title>Install Theatersoft Home on a Raspberry Pi 3</title>
    <meta name="viewport" content="width=device-width,user-scalable=0"/>
    <link rel="manifest" href="assets/manifest.json">
    <link rel="icon" type="image/png" href="/assets/theatersoft-logo-round-accent-48.png"/>
    <link rel="stylesheet" href="/theatersoft.css">
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                        (i[r].q = i[r].q || []).push(arguments)
                    }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-105697373-1', 'auto');
        ga('send', 'pageview');
    </script>
    <script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "Organization",
  "url": "http://www.theatersoft.com",
  "name": "Theatersoft",
  "logo": "http://www.theatersoft.com/assets/theatersoft-logo-round-accent.png"
}
    </script>
</head>
<body>
<div><nav class="_nav_nav"><div><ul><a href="/"><img src="/images/theatersoft-logo-only.svg" /><li>Home</li></a><div><li><a href="/install">Install</a></li><li><a href="/solutions">Solutions</a></li><li><a target="_blank" href="https://github.com/theatersoft">GitHub</a></li></div><li class="_nav_toggle"><button><svg width="768" height="768" viewBox="0 0 768 768"><path d="M96 160h576q13.3 0 22.6 9.4t9.4 22.6-9.4 22.6-22.6 9.4h-576q-13.2 0-22.6-9.4t-9.4-22.6 9.4-22.6 22.6-9.4zM96 544h576q13.3 0 22.6 9.4t9.4 22.6-9.4 22.6-22.6 9.4h-576q-13.2 0-22.6-9.4t-9.4-22.6 9.4-22.6 22.6-9.4zM96 352h576q13.3 0 22.6 9.4t9.4 22.6-9.4 22.6-22.6 9.4h-576q-13.2 0-22.6-9.4t-9.4-22.6 9.4-22.6 22.6-9.4z"></path></svg></button></li></ul></div></nav><header class="_header_header"><div class="_header_image"></div><div class="_header_gradient"></div><div class="_header_content"></div></header><main class="_page_page"><article><div><h2 id="install-theatersoft-home-on-a-raspberry-pi-3">Install Theatersoft Home on a Raspberry Pi 3</h2>
<p>Today I’ll walk through the steps to install Theatersoft Home on a Raspberry Pi 3. I’ll also connect a Z-Wave USB controller and test a Z-Wave device. When we finish we’ll have a custom home automation hub that can remotely control and monitor Z-Wave devices from any browser.</p>
<h2 id="requirements">Requirements</h2>
<p class="page-image"><img src="/images/install-rpi3/rpi3.jpg" alt="Install Theatersoft Home on a Raspberry Pi 3"></p>

<ul>
<li>Raspberry Pi 3 Model B, (case optional)</li>
<li>5V 2A power</li>
<li>ethernet network (or WiFi, not covered here)</li>
<li>microSD card</li>
<li>USB Z-Wave controller 908Mhz US frequency (SIGMA ACC-UZB3-U-STA or Aeotec Z-Stick Gen5)</li>
</ul>
<p>You’ll use a host PC to prepare the boot microSD card and connect to the Pi. My instructions assume a Linux PC, so you will need to perform equivalent steps for a different OS.</p>
<p>You should have a domain name to use as the address for the Theatersoft Client web app. The domain name allows dynamic DNS (so you can always reach your host even if your ISP changes your IP address), and is required for automatic HTTPS certificate renewal via LetsEncrypt. If you skip this, you’ll need to connect to your current IP address and override invalid certificate warnings from your browser.</p>
<h2 id="start-installing">Start installing</h2>
<h3 id="1-prepare-the-microsd-card-on-pc-">1. Prepare the microSD card (on PC)</h3>
<p>Download the latest <a href="https://www.raspberrypi.org/downloads/raspbian/">RASPBIAN STRETCH LITE</a> (not DESKTOP) image zip file.</p>
<p>Insert the microSD into your PC card reader and note the device name in <code>gnome-disks</code>.</p>
<p>Unzip the image to the microSD (as <em>root</em> - be sure to replace X with the correct device name):</p>
<pre><code><span class="token function">sudo</span> -i
zcat 2017-09-07-raspbian-stretch-lite.zip <span class="token operator">></span> /dev/sdX
</code></pre><p>Mount the boot partition in <code>gnome-disks</code> and create a file named <code>ssh</code> at the root of that partition:</p>
<pre><code><span class="token function">touch</span> /media/<span class="token variable">$USER</span>/boot/ssh
</code></pre><p>Unmount and remove the microSD card.</p>
<h3 id="2-boot-the-pi-and-set-up-ssh">2. Boot the Pi and set up SSH</h3>
<p>Insert the microSD card into the Pi and connect power and network. After a few seconds you’ll see the ethernet indicators working and you’ll be able to connect.</p>
<p>Since the Pi is running Avahi, connect with <code>ssh pi@raspberrypi.local</code> (the password is raspberry). If that doesn’t work, you will need to find the Pi’s IP address. You can check your router’s admin page or use <code>nmap</code> if available, e.g. <code>nmap -sn 192.168.1.0/24 | grep pi</code>.</p>
<p>Update your local ssh config so you can simply use <code>pi</code> as the host:</p>
<pre><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> EOF <span class="token operator">>></span> ~/.ssh/config
Host pi
Hostname raspberrypi.local
User pi
EOF
</code></pre><p>Secure the Pi by using ssh key authentication:</p>
<pre><code>ssh-copy-id -i ~/.ssh/id_rsa pi
</code></pre><p>And disable ssh password authentication on the Pi (<code>ssh pi</code>):</p>
<pre><code><span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s|#PasswordAuthentication yes|PasswordAuthentication no|'</span> /etc/ssh/sshd_config
</code></pre><h3 id="3-install-node-js">3. Install Node.js</h3>
<p>The version of node in the raspbian repository is too old. We’ll use <a href="https://github.com/creationix/nvm">Node Version Manager</a> instead:</p>
<pre><code>curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.4/install.sh <span class="token operator">|</span> <span class="token function">bash</span>
</code></pre><p>Close and reopen your ssh terminal, then install node 8:</p>
<pre><code>nvm <span class="token function">install</span> 8
</code></pre><p>Now <code>which node</code> will return something like <code>/home/pi/.nvm/versions/node/v8.5.0/bin/node</code> but the Theatersoft Home systemd service requires <code>node</code> and <code>npm</code> to be in <code>/usr/local/bin</code>. You’ll need to symlink them:</p>
<pre><code>n<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">which</span> node<span class="token variable">)</span></span><span class="token punctuation">;</span> n<span class="token operator">=</span><span class="token variable">${n%/node}</span>
<span class="token function">sudo</span> <span class="token function">ln</span> -sf <span class="token variable">$n</span>/node /usr/local/bin/node
<span class="token function">sudo</span> <span class="token function">ln</span> -sf <span class="token variable">$n</span>/npm /usr/local/bin/npm
</code></pre><h3 id="4-install-theatersoft-home">4. Install Theatersoft Home</h3>
<p>Create a directory where you’ll create your Theatersoft configuration (I suggest you name it the same as your domain name). Then install, configure, and deploy <code>Home</code>:</p>
<pre><code><span class="token function">mkdir</span> example <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> example <span class="token operator">&amp;&amp;</span> <span class="token function">npm</span> <span class="token function">install</span> @theatersoft/home
<span class="token function">npm</span> explore @theatersoft/home <span class="token function">npm</span> run config
<span class="token function">npm</span> run deploy
</code></pre><p>Theatersoft is now running on port 443 (but you cannot connect a browser until we configure the SSL certificate):</p>
<pre><code>pi@raspberrypi:~ $ systemctl status theatersoft
● theatersoft.service - Theatersoft server
   Loaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/theatersoft.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu 2017-09-14 03:39:55 UTC<span class="token punctuation">;</span> 15min ago
 Main PID: 22385 <span class="token punctuation">(</span>node<span class="token punctuation">)</span>
   CGroup: /system.slice/theatersoft.service
           └─22385 /usr/local/bin/node server.js

Sep 14 03:39:55 raspberrypi systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started Theatersoft server.
Sep 14 03:39:57 raspberrypi authbind<span class="token punctuation">[</span>22385<span class="token punctuation">]</span>: Theatersoft <span class="token punctuation">{</span> parent: undefined, children: <span class="token punctuation">{</span> server: Promise <span class="token punctuation">{</span> <span class="token operator">&lt;</span>pending<span class="token operator">></span>
Sep 14 03:39:57 raspberrypi authbind<span class="token punctuation">[</span>22385<span class="token punctuation">]</span>: Theatersoft Bus name is /
Sep 14 03:39:57 raspberrypi authbind<span class="token punctuation">[</span>22385<span class="token punctuation">]</span>: Theatersoft Config raspberrypi <span class="token punctuation">{</span> _letsencrypt: <span class="token punctuation">{</span> domain: <span class="token string">'example.com'</span>, e
Sep 14 03:39:57 raspberrypi authbind<span class="token punctuation">[</span>22385<span class="token punctuation">]</span>: Theatersoft starting Session undefined
Sep 14 03:39:57 raspberrypi authbind<span class="token punctuation">[</span>22385<span class="token punctuation">]</span>: Theatersoft Client /opt/theatersoft/node_modules/@theatersoft/client
Sep 14 03:39:57 raspberrypi authbind<span class="token punctuation">[</span>22385<span class="token punctuation">]</span>: Theatersoft Listening on port 443
Sep 14 03:39:57 raspberrypi authbind<span class="token punctuation">[</span>22385<span class="token punctuation">]</span>: Theatersoft Starting <span class="token function">service</span> Device
Sep 14 03:39:57 raspberrypi authbind<span class="token punctuation">[</span>22385<span class="token punctuation">]</span>: Theatersoft Started <span class="token function">service</span> Device
</code></pre><blockquote>
<p>I noticed at this point I couldn’t control my service e.g. <code>systemctl restart theatersoft</code> with user <code>pi</code>:</p>
<pre><code>Failed to restart theatersoft.service: The name org.freedesktop.PolicyKit1 was not provided by any .service files
</code></pre><p>Is normal for Raspbian? Though it works as <code>root</code>, I’m used to using a nonroot user. So to fix it:</p>
<pre><code><span class="token function">sudo</span> apt <span class="token function">install</span> policykit-1
</code></pre><p>Then to fix policykit authentication requesting <code>root</code> instead of <code>pi</code> password:</p>
<pre><code><span class="token function">sudo</span> -i
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> EOF <span class="token operator">>></span> /etc/polkit-1/localauthority.conf.d/51-admin.conf
<span class="token punctuation">[</span>Configuration<span class="token punctuation">]</span>
AdminIdentities<span class="token operator">=</span>unix-group:sudo
EOF
systemctl restart polkit.service
</code></pre></blockquote>
<h3 id="5-setup-ddclient-and-configure-domain-name">5. Setup ddclient and configure domain name</h3>
<blockquote>
<p>RECOMMENDED FOR TESTING ONLY</p>
<p>You can create a self-signed certificate instead of configuring a domain name:</p>
<pre><code><span class="token function">cd</span> /opt/theatersoft/.config/theatersoft
openssl req -x509 -newkey rsa:4096 -keyout server.key -out server.cer -days 365 -nodes
</code></pre><p>Accept the defaults when prompted. Skip to <em>Restart the Theatersoft server</em>.</p>
</blockquote>
<p>Install ddclient:</p>
<pre><code><span class="token function">sudo</span> apt <span class="token function">install</span> ddclient
</code></pre><p>For a domain registered at <code>namecheap.com</code>, refer to <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/583/11/how-do-i-configure-ddclient">How do I configure DDClient?</a> to answer the installation prompts and edit the configuration in <code>/etc/ddclient.conf</code>. Otherwise, find a similar guide for your registrar.</p>
<pre><code><span class="token comment" spellcheck="true"># Configuration file for ddclient generated by debconf</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># /etc/ddclient.conf</span>

use<span class="token operator">=</span>web, web<span class="token operator">=</span>dynamicdns.park-your-domain.com/getip
protocol<span class="token operator">=</span>namecheap
server<span class="token operator">=</span>dynamicdns.park-your-domain.com
login<span class="token operator">=</span>example.com
password<span class="token operator">=</span><span class="token operator">&lt;</span>not shown<span class="token operator">></span>
home
</code></pre><p>This will automatically update the nameserver for <code>home.example.com</code>. We can see if it worked by checking the end of the system log: <code>journalctl -e</code>:</p>
<pre><code>Sep 14 20:48:01 raspberrypi ddclient<span class="token punctuation">[</span>26501<span class="token punctuation">]</span>: SUCCESS:  updating home: good: IP address <span class="token keyword">set</span> to 50.35.xx.xx
</code></pre><p>Forward port 443 from the internet to your internal Pi IP address in your network router settings. This process will vary depending on your router.</p>
<p>You’re ready to enable letsencypt in <code>config.json</code>. Remove the underscore from  the <code>_letsencrypt</code> property name and provide your values for <code>domain</code> and <code>email</code>.</p>
<pre><code>  <span class="token string">"letsencrypt"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"domain"</span><span class="token keyword">:</span> <span class="token string">"home.example.com"</span>,
    <span class="token string">"email"</span><span class="token keyword">:</span> <span class="token string">"name@example.com"</span>,
    <span class="token string">"production"</span><span class="token keyword">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>,
</code></pre><p>Restart the Theatersoft server: <code>systemctl restart theatersoft</code>.</p>
<h3 id="6-pair-theatersoft-client">6. Pair Theatersoft Client</h3>
<p>Open the Theatersoft Client app in your browser, e.g. <code>https://home.example.com</code> (or <code>https://raspberrypi.local</code> if testing without a domain name).</p>
<p class="page-image"><img src="/images/install-rpi3/pinpad.png" alt="Theatersoft Pinpad"></p>

<p>This is the pinpad login screen, which appears when your browser doesn’t have a valid session cookie. Click the lock icon to pair with the default password <code>0000</code>. (You can change the password in <code>config.json</code>.) You are now connected and see a default black background since you have no camera feeds configured.</p>
<p>Click (or tap - the client is fully touch enabled) near the center of the page to activate the tapmenu. This is the launching point for the Theatersoft UI. Since the tapmenu is sensitive to the relative position of two taps it’s easy to use without even looking at the screen. Try tapping as fast as your device can handle!</p>
<p class="page-image"><img src="/images/install-rpi3/tapmenu.png" alt="Theatersoft Tapmenu"></p>

<p>Before continuing, open the top status screen. Turn off the <code>Enable pairing</code> switch. Pairing should normally be disabled to block brute force attacks. Turn on <code>Enable notifications</code> to receive web push notifications including failed pairing attempts and new paired connections.</p>
<h3 id="7-install-zwave">7. Install ZWave</h3>
<p>Build the OpenZWave project, which is a dependency of the ZWave service:</p>
<pre><code><span class="token function">cd</span> ~/
<span class="token function">wget</span> https://github.com/OpenZWave/open-zwave/archive/v1.4.zip
unzip v1.4.zip 
<span class="token function">cd</span> open-zwave-1.4
<span class="token function">sudo</span> apt <span class="token function">install</span> libudev-dev git-core
<span class="token function">make</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>
<span class="token function">sudo</span> <span class="token function">mv</span> /usr/local/lib/arm-linux-gnueabihf/libopenzwave.so* /usr/lib/arm-linux-gnueabihf/
</code></pre><p>Add the ZWave service with <code>nano ~/example/config.json</code>. Insert the following object after the existing Device service:</p>
<pre><code>        ,
        <span class="token punctuation">{</span>
          <span class="token string">"enabled"</span><span class="token keyword">:</span> true,
          <span class="token string">"module"</span><span class="token keyword">:</span> <span class="token string">"@theatersoft/zwave"</span>,
          <span class="token string">"export"</span><span class="token keyword">:</span> <span class="token string">"ZWave"</span>,
          <span class="token string">"name"</span><span class="token keyword">:</span> <span class="token string">"ZWave"</span>,
          <span class="token string">"config"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"/dev/ttyACM0"</span>,
            <span class="token string">"options"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
              <span class="token string">"Logging"</span><span class="token keyword">:</span> true,
              <span class="token string">"ConsoleOutput"</span><span class="token keyword">:</span> true,
              <span class="token string">"SaveLogLevel"</span><span class="token keyword">:</span> 5
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre><p>Then reconfigure and redeploy. This performs all installation and restarts the server.</p>
<pre><code><span class="token function">npm</span> run config deploy
</code></pre><p>The ZWave service is now started and the client shows ZWave in the Services Settings (tap, left tap, Services):</p>
<p class="page-image"><img src="/images/install-rpi3/settings.png" alt="Theatersoft Service Settings"></p>

<h3 id="8-test-a-zwave-device">8. Test a ZWave device</h3>
<p>Open ZWave service settings and turn on Add Device:</p>
<p class="page-image"><img src="/images/install-rpi3/zwave-settings.png" alt="Theatersoft ZWave Service Settings"></p>

<p>The controller is now in <em>inclusion</em> mode, ready to add new Z-Wave devices. Check your device to learn how to trigger include/exclude. The Zooz chime device that I’ve added required a triple press of the button inside the battery compartment. Look for the new switch in the devices list (tap, right tap, Switch).</p>
<p class="page-image"><img src="/images/install-rpi3/zwave-switch.png" alt="Theatersoft ZWave Switch"></p>

<p>For general device settings and ZWave device settings tap elsewhere on the list item. The name setting is currently readonly in the UI but you can override it in <code>/opt/theatersoft/.config/theatersoft/zwave.config.json</code>.</p>
<p class="page-image"><img src="/images/install-rpi3/device-settings.png" alt="Theatersoft ZWave Device Settings"></p>

<h2 id="next-steps">Next steps</h2>
<p>Find more Theatersoft packages on <a href="https://www.npmjs.com/~theatersoft">NPM</a> and <a href="https://github.com/theatersoft">Github</a>.</p>
</div><div id="disqus_thread" style="margin-top:3em;"><script>var disqus_config = function () {
this.page.url = 'https://www.theatersoft.com/install/';
this.page.identifier = 'install-rpi3';
};
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://theatersoft.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script></div></article></main></div>
</body>
</html>