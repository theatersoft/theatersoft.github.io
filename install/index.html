<!DOCTYPE html>
<html>
<head>
    <title>Install Theatersoft Home on a Raspberry Pi 3</title>
    <meta name="viewport" content="width=device-width,user-scalable=0"/>
    <link rel="manifest" href="assets/manifest.json">
    <link rel="icon" type="image/png" href="/assets/theatersoft-logo-round-accent-48.png"/>
    <link rel="stylesheet" href="/theatersoft.css">
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                        (i[r].q = i[r].q || []).push(arguments)
                    }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-105697373-1', 'auto');
        ga('send', 'pageview');
    </script>
    <script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "Organization",
  "url": "http://www.theatersoft.com",
  "name": "Theatersoft",
  "logo": "http://www.theatersoft.com/assets/theatersoft-logo-round-accent.png"
}
    </script>
</head>
<body>
<div><nav class="_nav_nav"><div><ul><a href="/"><img src="/images/theatersoft-logo-only.svg" /><li>Home</li></a><div><li><a href="/install">Install</a></li><li><a href="/solutions">Solutions</a></li><li><a target="_blank" href="https://github.com/theatersoft">GitHub</a></li></div><li class="_nav_toggle"><button><svg width="768" height="768" viewBox="0 0 768 768"><path d="M96 160h576q13.3 0 22.6 9.4t9.4 22.6-9.4 22.6-22.6 9.4h-576q-13.2 0-22.6-9.4t-9.4-22.6 9.4-22.6 22.6-9.4zM96 544h576q13.3 0 22.6 9.4t9.4 22.6-9.4 22.6-22.6 9.4h-576q-13.2 0-22.6-9.4t-9.4-22.6 9.4-22.6 22.6-9.4zM96 352h576q13.3 0 22.6 9.4t9.4 22.6-9.4 22.6-22.6 9.4h-576q-13.2 0-22.6-9.4t-9.4-22.6 9.4-22.6 22.6-9.4z"></path></svg></button></li></ul></div></nav><header class="_header_header"><div class="_header_image"></div><div class="_header_gradient"></div><div class="_header_content"></div></header><main class="_page_page"><article><div><h2 id="install-theatersoft-home-on-a-raspberry-pi-3">Install Theatersoft Home on a Raspberry Pi 3</h2>
<p>Today I’ll walk through the steps to install Theatersoft Home on a Raspberry Pi 3. I’ll also connect a Z-Wave USB controller and include a couple of Z-Wave devices. When we finish we’ll have a working home automation hub that can be controlled from any browser, and you’ll be ready to build your own.</p>
<h2 id="what-do-we-need-">What do we need?</h2>
<p>Here’s my RPI3 inside a protective case:</p>
<p class="ts-image"><img src="/images/blog/rpi3-install.png" alt="Install Theatersoft Home on a Raspberry Pi 3"></p>

<p>You’ll need:</p>
<ul>
<li>Raspberry Pi 3 Model B, (case optional)</li>
<li>5V 2A power</li>
<li>ethernet network (or WiFi, but I’ll skip that for now)</li>
<li>microSD card</li>
<li>Z-Wave controller (SIGMA ACC-UZB3-U-STA)</li>
</ul>
<p>You should also have a domain name that you’ll use to host the web app. The domain name will let us set up dynamic DNS (so you can always reach your host even if your ISP changes your IP address), and automatic HTTPS certificates. You could skip this, but then you’d need to connect to your current IP address and override invalid certificate warnings from browsers.</p>
<p>Let’s say my domain is <code>example.com</code> and registered with Namecheap.com. The instructions may be slightly different for other registrars. I’m using Linux on my PC, so you may need to perform the equivalent steps for a different OS.</p>
<h2 id="start-installing">Start installing</h2>
<h3 id="1-prepare-the-microsd-card-on-pc-">1. Prepare the microSD card (on PC)</h3>
<p>Download the latest <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Stretch Lite</a> image zip file. We’ll only use the Lite image because we have no use for the full desktop.</p>
<p>Insert the microSD into your PC card reader and note the device name in <code>gnome-disks</code>.</p>
<p>Unzip the image to the microSD (as <strong>root</strong> - replace X with the correct device name):</p>
<pre><code>zcat 2017-09-07-raspbian-stretch-lite.zip &gt; /dev/sdX
</code></pre><p>Mount the boot partition in <code>gnome-disks</code>. Then create a file named <code>ssh</code> (replace X with your user name):</p>
<pre><code>touch /media/user/boot/ssh
</code></pre><p>Unmount and remove the microSD card.</p>
<h3 id="2-boot-the-rpi-and-set-up-ssh">2. Boot the RPI and set up SSH</h3>
<p>Insert the microSD card in the RPI and connect power and network. After a few seconds you’ll see the ethernet indicators working and you’ll be able to connect.</p>
<p>You may need to find the RPI’s ip address. You can check your router’s admin page or:</p>
<pre><code>nmap -sn 192.168.1.0/24 | grep pi
Nmap scan report for pi (192.168.1.91)
</code></pre><p>Since the RPI is running Avahi, I’ll connect using <code>ssh pi@raspberrypi.local</code>, or use your own ip address (the password is raspberry).</p>
<blockquote>
<p>Secure the RPI by configuring key authentication and disabling password authentication:</p>
<pre><code>ssh-copy-id -i ~/.ssh/id_rsa pi@raspberrypi.local
</code></pre><p>Then update your ssh config:</p>
<pre><code>cat &lt;&lt; EOF &gt;&gt; ~/.ssh/config
Host pi
Hostname raspberrypi.local
User pi
EOF
</code></pre><p>Then <code>ssh pi</code> and disable ssh password authentication on the RPI:</p>
<pre><code>sudo nano /etc/ssh/sshd_config
</code></pre><p>Change <code>#PasswordAuthentication yes</code> to <code>PasswordAuthentication no</code> then exit and save.</p>
</blockquote>
<h3 id="3-install-node-js">3. Install Node.js</h3>
<p>If we installed node from the raspbian repository we’d only get v4.8.2. That’s too old. We’ll use <a href="https://github.com/creationix/nvm">Node Version Manager</a> instead:</p>
<pre><code>curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.4/install.sh | bash
</code></pre><p>Close and reopen your ssh terminal. Then install node 8:</p>
<pre><code>nvm install 8
</code></pre><p>Now <code>which node</code> will return something like <code>/home/pi/.nvm/versions/node/v8.5.0/bin/node</code> but the Theatersoft Home systemd service requires <code>node</code> and <code>npm</code> to be in <code>/usr/local/bin</code>. You’ll need to symlink them:</p>
<pre><code>n=$(which node); n=${n%/node}
sudo ln -sf $n/node /usr/local/bin/node
sudo ln -sf $n/npm /usr/local/bin/npm
</code></pre><h3 id="4-install-theatersoft-home">4. Install Theatersoft Home</h3>
<p>Create a directory where you’ll create your Theatersoft configuration (I suggest you name it the same as your domain name). Then install, configure, and deploy <code>Home</code>:</p>
<pre><code>mkdir example &amp;&amp; cd example &amp;&amp; npm install @theatersoft/home
npm explore @theatersoft/home npm run config
npm run deploy
</code></pre><p>Theatersoft is now running on port 443 (but you cannot connect with your browser until we configure a SSL certificate in the next step):</p>
<pre><code>pi@raspberrypi:~ $ systemctl status theatersoft
● theatersoft.service - Theatersoft server
   Loaded: loaded (/etc/systemd/system/theatersoft.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2017-09-14 03:39:55 UTC; 15min ago
 Main PID: 22385 (node)
   CGroup: /system.slice/theatersoft.service
           └─22385 /usr/local/bin/node server.js

Sep 14 03:39:55 raspberrypi systemd[1]: Started Theatersoft server.
Sep 14 03:39:57 raspberrypi authbind[22385]: Theatersoft { parent: undefined, children: { server: Promise { &lt;pending&gt;
Sep 14 03:39:57 raspberrypi authbind[22385]: Theatersoft Bus name is /
Sep 14 03:39:57 raspberrypi authbind[22385]: Theatersoft Config raspberrypi { _letsencrypt: { domain: &#39;example.com&#39;, e
Sep 14 03:39:57 raspberrypi authbind[22385]: Theatersoft starting Session undefined
Sep 14 03:39:57 raspberrypi authbind[22385]: Theatersoft Client /opt/theatersoft/node_modules/@theatersoft/client
Sep 14 03:39:57 raspberrypi authbind[22385]: Theatersoft Listening on port 443
Sep 14 03:39:57 raspberrypi authbind[22385]: Theatersoft Starting service Device
Sep 14 03:39:57 raspberrypi authbind[22385]: Theatersoft Started service Device
</code></pre><blockquote>
<p>I noticed at this point I couldn’t control my service e.g. <code>systemctl restart theatersoft</code> with user <code>pi</code>:</p>
<pre><code>Failed to restart theatersoft.service: The name org.freedesktop.PolicyKit1 was not provided by any .service files
</code></pre><p>Is normal for Raspbian? Though it works as <code>root</code>, I’m used to using a nonroot user. So to fix it:</p>
<pre><code>sudo apt install policykit-1
</code></pre><p>Then to fix policykit authentication requesting <code>root</code> instead of <code>pi</code> password:</p>
<pre><code>sudo -i
cat &lt;&lt; EOF &gt;&gt; /etc/polkit-1/localauthority.conf.d/51-admin.conf
[Configuration]
AdminIdentities=unix-group:sudo
EOF
systemctl restart polkit.service
</code></pre></blockquote>
<h3 id="5-setup-ddclient-and-configure-domain-name">5. Setup ddclient and configure domain name</h3>
<blockquote>
<p>RECOMMENDED FOR TESTING ONLY:</p>
<p>You can create a self-signed certificate instead of configuring a domain name (accept all the defaults prompted from openssl):</p>
<pre><code>cd /opt/theatersoft/.config/theatersoft
openssl req -x509 -newkey rsa:4096 -keyout server.key -out server.cer -days 365 -nodes
</code></pre></blockquote>
<p>Install ddclient:</p>
<pre><code>sudo apt install ddclient
</code></pre><p>If your domain registrar is <code>namecheap.com</code>, refer to <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/583/11/how-do-i-configure-ddclient">How do I configure DDClient?</a> to answer the installation prompts and edit the configuration in <code>/etc/ddclient.conf</code>. Otherwise, find a similar guide from your registrar.</p>
<pre><code># Configuration file for ddclient generated by debconf
#
# /etc/ddclient.conf

use=web, web=dynamicdns.park-your-domain.com/getip
protocol=namecheap
server=dynamicdns.park-your-domain.com
login=example.com
password=&lt;not shown&gt;
home
</code></pre><p>This should update the nameserver for <code>home.example.com</code>. We can see if it worked by checking the end of the system log with <code>journalctl -e</code>:</p>
<pre><code>Sep 14 20:48:01 raspberrypi ddclient[26501]: SUCCESS:  updating home: good: IP address set to 50.35.xx.xx
</code></pre><p>Next, forward port 443 from the internet to your internal RPI IP address in your network router settings. This process will vary depending on your router.</p>
<p>Now you’re ready to enable letsencypt in <code>config.json</code>. Remove the underscore from  the <code>_letsencrypt</code> property name and provide your values for <code>domain</code> and <code>email</code>.</p>
<pre><code>  &quot;letsencrypt&quot;: {
    &quot;domain&quot;: &quot;home.example.com&quot;,
    &quot;email&quot;: &quot;name@example.com&quot;,
    &quot;production&quot;: true
  },
</code></pre><p>Restart the Theatersoft server <code>systemctl restart theatersoft</code>.</p>
<h3 id="6-pair-theatersoft-client">6. Pair Theatersoft Client</h3>
<p>Open the Theatersoft Client app in your browser, e.g. <code>https://home.example.com</code> (or <code>https://raspberrypi.local</code> if testing without a domain name).</p>
<p>This is the pinpad login screen, which appears when your browser doesn’t have a valid session cookie. Click the lock icon to pair with the default password <code>0000</code>. (You can change the default in <code>config.json</code>.) You are now connected and see a default black background since you have no camera feeds configured.</p>
<p class="ts-image"><img src="/images/blog/pinpad-screenshot.png" alt="Theatersoft Pinpad screenshot"></p>

<blockquote>
<p>Click (or tap - the client is fully touch enabled) near the center of the page to activate the tapmenu, and click the top status icon.</p>
<p>Turn off the <code>Enable pairing</code> switch when you’re not pairing, so no one else can pair with your server even if they know your password. Pairing should normally be disabled to block brute force attacks.</p>
</blockquote>
<h3 id="7-install-zwave">7. Install ZWave</h3>
<p>We’ll need to build the OpenZWave libs:</p>
<pre><code>cd ~/
wget https://github.com/OpenZWave/open-zwave/archive/v1.4.zip
unzip v1.4.zip 
cd open-zwave-1.4
sudo apt install libudev-dev git-core
make
sudo make install
sudo mv /usr/local/lib/arm-linux-gnueabihf/libopenzwave.so* /usr/lib/arm-linux-gnueabihf/
</code></pre><p>Then add the Theatersoft ZWave service to your example <code>config.json</code>:</p>
<pre><code>,
        {
          &quot;enabled&quot;: true,
          &quot;module&quot;: &quot;@theatersoft/zwave&quot;,
          &quot;export&quot;: &quot;ZWave&quot;,
          &quot;name&quot;: &quot;ZWave&quot;,
          &quot;config&quot;: {
            &quot;port&quot;: &quot;/dev/ttyACM0&quot;,
            &quot;options&quot;: {
              &quot;Logging&quot;: true,
              &quot;ConsoleOutput&quot;: true,
              &quot;SaveLogLevel&quot;: 5
            }
          }
        }
</code></pre><p>…right after the existing object in <code>hosts[0].services[]</code>.</p>
<p>Then reconfigure and redeploy:</p>
<pre><code>npm run config deploy
</code></pre><h3 id="8-test-a-zwave-device">8. Test a ZWave device</h3>
</div></article></main></div>
</body>
</html>